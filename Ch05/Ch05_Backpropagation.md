# Chapter05 오차역전파법 (Backpropagation)

- Chapter04 에서는 가중치 매개변수에 대한 손실함수의 기울기를 수치 미분을 사용해 구했다.
- 하지만 수치 미분은 단순하고 구현하기도 쉽지만 계산 시간이 너무 오래 걸린다.
- 그래서 이번 장에서는 가중치 매개변수의 기울기를 효과적으로 계산하는 `오차역전파법(backpropagation)`에
대하여 학습할 것이다.
- 오차역전파법을 제대로 이해하는 방법에는 두 가지가 있다.
  - 하나는 수식을 통한 것
  - 다른 하나는 계산 그래프를 통한 것
- 기계학습을 다루는 책 대부분은 수식을 중심으로 이야기를 전개하지만 이번 장에서는 계산 그래프를 사용하여
'시각적'으로 이해를 해보도록 하겠다.


## 5.1 계산 그래프

- `계산 그래프 (computational graph)`는 계산 과정을 그래프로 나타낸 것이다.
- 여기에서의 그래프는 복수의 node와 edge로 표현된다.
- 이번 절에서는 계산 그래프에 친숙해지기 위해 간단한 문제에서부터 한 단계씩 나아가면서 마지막에는 오차 역전파법에
도달하겠다.

### 5.1.1 계산 그래프로 풀다
- 계산 그래프는 뒤에 나올 복잡한 계산에서 진짜 위력을 발휘하므로 지금 사용법을 익혀둬야 한다.
- 먼저 간단한 문제를 통해 계산 그래프에 익숙해져보자.
- 문제 1 : 슈퍼에서 1개에 100원인 사과를 2개 샀다. 이때 지불 금액을 구하자. 단 소비세가 10% 부과된다.
- 이를 계산 그래프로 나타내보자

<img src="../dataset/mdImage/그림5-1.png">

- 처음에 사과의 100원이 'x' 노드로 흐르고 '사과의 개수'라는 변수랑 곱해져 200원이 되었다.
- 또한 이 200원은 다음 'x' 노드로 흘러 '소비세'라는 변수와 곱해져 220원이 되었다.

- 그럼 또 다른 문제를 풀어보자
- 문제 2 : 슈퍼에서 사과 2개, 귤 3개를 샀다. 사과는 1개에 100원, 귤은 1개 150원이다. 소비세가 10%
일 때 지불 금액을 구해라

<img src="../dataset/mdImage/그림5-3.jpeg">

- 이 문제에서는 덧셈 노드인 '+'가 새로 등장하여 사과와 귤의 금액을 합산한다.
- 계산 그래프는 왼쪽에서 오른쪽으로 계산을 진행한다.
- 지금까지 살펴본 것 처럼 계산 그래프를 이용한 문제 풀이는 다음 흐름과 같다.
  1. 계산 그래프를 구성한다.
  2. 그래프에서 계산을 왼쪽에서 오른쪽으로 진행한다.
- 여기서 2번째 '계산을 왼쪽 -> 오른쪽 으로 진행'하는 단계를 `순전파(forward propagation)`라고 하낟.
- 순전파는 계산 그래프의 출발점부터 종착점으로의 전파이다.
- 순전파라는 이름이 있다변 반대 방향의 전파도 있는데(오른쪽 -> 왼쪽), 이를 `역전파(backward propagation)`
라고 한다.
- 이 역전파는 이후에 미분을 계산할 때 중요한 역할을 한다.


### 5.1.2 국소적 계산
- 계산 그래프의 특징은 '국소적 계산'을 전파함으로써 최종 결과를 얻는다는 점이다.
- 여기서 국소적이란 '자신과 직접 관계된 작은 범위'라는 뜻이다.
- 각 노드는 에지에서 들어오는 값이 어떻게 계산되었느냐와는 상관없이, 단지 들어온 엣지의 값으로 자신의 연산만 수행
하여 다음 노드(혹은 엣지)로 전달하기만 하면 된다.
- 즉, 각 노드는 자신과 관련한 계산 외에는 아무것도 신경 쓸 게 없다.
- 이처럼 계산 그래프는 국소적 계산에 집중하며 전체 계산이 제아무리 복잡하더라도 각 단계에서 하는 일은 해당 노드의
'국소적 계산'이다.
- 국소적 계산은 단순하지만 그 결과를 전달함으로써 전체를 구성하는 복잡한 계산을 해낼 수 있다.


### 5.1.3 왜 계산 그래프로 푸는가 ? 
- 지금까지 계산 그래프를 사용하여 문제를 풀어봤는데, 그럼 계산 그래프의 이점은 무엇일까 ? 
  1. '국소적 계산'이다. 전체가 아무리 복잡해도 각 노드에서는 단순한 계산에만 집중하여 문제를 단순화할 수 있다.
  2. 계산 그래프는 중간 계산 결과를 모두 보관할 수 있다. 예를 들어 사과 2개까지 계산 했을 때의 금액은 200원이다.
  3. `가장 큰 이유는 바로 역전파를 통해 '미분'을 효율적으로 계산할 수 있다는 점이다.`

- 아까 문제 1에 대해서, 사과 가격이 오르면 최종 금액에 어떤 영향을 끼치는지 알고 싶다고 해보자.
- 이는 '사과 가격에 대한 지불금액의 미분'을 구하는 문제다.
- 기호로 나타내면 사과 값을 x, 지불 금액을 L 이라고 했을 때 dL / dx 를 구하는 것이다.
- 이 미분 값은 사과 값이 '아주 조금' 올랐을 때 지불 금액이 얼마나 증가하느냐를 표시한 것이다.
- 앞에서 말했듯이 '사과 가격에 대한 지불 금액의 미분'같은 값은 계산 그래프에서 역전파를 하면 구할 수 있다.
- 먼저 결과를 보자.

<img src="../dataset/mdImage/그림5-5.jpeg" width="900">

- 역전파는 순전파와는 반대 방향의 화살표(굵은 선)으로 그린다.
- 이 전파는 '국소적 미분'을 전달하고 그 미분 값은 화살표의 아래에 적는다.
- 이 예에서는 오른쪽 -> 왼쪽 방향으로 1 -> 1.1 -> 2.2 순으로 미분 값을 전달한다.
- 이 결과로부터 사과 가격에 대한 지불 금액의 미분 값은 2.2라고 할 수 있고, 이는 사과가 1원 오르면 최종
금액은 2.2원 오른다고 해석할 수 있다.
- 여기에서는 사과 가격에 대한 미분만 구했지만, '소비세에 대한 지불 금액의 미분'이나 '사과 개수에 대한 지불
금액의 미분'도 같은 순서로 구할 수 있다.
- 그리고 그때는 중간까지 구한 미분 결과를 공유할 수 있어 다수의 미분을 효율적으로 계산할 수 있다.
- 이처럼 계산 그래프의 이점은 순전파와 역전파를 활용해 각 변수의 미분을 효율적으로 구할 수 있다는 것이다.


## 5.2 연쇄법칙



